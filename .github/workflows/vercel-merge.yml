name: 'Deploy to vercel on merge'
on:
  push:
    branches:
      - 'main'
jobs:
  build_and_deploy:
    permissions: 'write-all'
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@v4'

      - name: 'Install pnpm'
        uses: 'pnpm/action-setup@v4'
        with:
          version: '10'
          run_install: false

      - name: 'Install Node.js'
        uses: 'actions/setup-node@v4'
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 'Install dependencies'
        run: 'pnpm install'

      - name: 'Install vercel'
        run: 'pnpm install vercel --global'

      - name: 'Cache Next.js build cache'
        uses: 'actions/cache@v4'
        with:
          path: '.next/cache'
          key: "nextjs-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}"
          restore-keys: |
            nextjs-${{ runner.os }}

      - name: 'Build project'
        run: 'pnpm build'

      - name: Deploy to Vercel
        id: vercel_deploy
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            DEPLOY_URL=$(vercel deploy \
              --token ${{ secrets.VERCEL_TOKEN }} \
              --org ${{ secrets.VERCEL_ORG_ID }} \
              --project ${{ secrets.VERCEL_PROJECT_ID }} \
              --scope ${{ secrets.VERCEL_ORG_ID }} \
              --prod \
              --yes \
              --prebuilt)
          else
            DEPLOY_URL=$(vercel deploy \
              --token ${{ secrets.VERCEL_TOKEN }} \
              --org ${{ secrets.VERCEL_ORG_ID }} \
              --project ${{ secrets.VERCEL_PROJECT_ID }} \
              --scope ${{ secrets.VERCEL_ORG_ID }} \
              --yes \
              --prebuilt)
          fi

          echo "preview-url=$DEPLOY_URL" >> $GITHUB_OUTPUT
