name: 'Create vercel preview URL on pull request'
on: ['pull_request']
jobs:
  build_and_deploy:
    permissions: 'write-all'
    runs-on: 'ubuntu-latest'
    steps:
      - name: 'Checkout'
        uses: 'actions/checkout@v4'

      - name: 'Install pnpm'
        uses: 'pnpm/action-setup@v4'
        with:
          version: '10'
          run_install: false

      - name: 'Install Node.js'
        uses: 'actions/setup-node@v4'
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: 'Install dependencies'
        run: 'pnpm install'

      - name: 'Cache Next.js build cache'
        uses: 'actions/cache@v4'
        with:
          path: '.next/cache'
          key: "nextjs-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}"
          restore-keys: |
            nextjs-${{ runner.os }}

      - name: 'Build project'
        run: 'pnpm build'

      - name: 'Link Vercel project'
        run: |
          vercel link \
            --token ${{ secrets.VERCEL_TOKEN }} \
            --scope ${{ secrets.VERCEL_ORG_ID }} \
            --yes

      - name: 'Deploy to Vercel'
        id: 'vercel-deploy'
        uses: 'amondnet/vercel-action@v25'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          scope: ${{ secrets.VERCEL_ORG_ID}}
          working-directory: '.'

      - name: 'preview-url'
        run: |
          echo ${{ steps.vercel-deploy.outputs.preview-url }}
